name: CI - Tuesday API & Frontend

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # CI
  tests:
    runs-on: ubuntu-latest

    env:
      DB_USER: app_user
      DB_PASS: app_pass
      DB_NAME: app_db
      DB_PORT: 3306
      DB_HOSTS: 127.0.0.1
      JWT_SECRET: test-secret
      JWT_EXPIRES_MIN: 60
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          # instala o mysql no runner
      - name: Instalar MySQL no runner
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server

          sudo systemctl start mysql

          # Usa o usuário de manutenção do sistema (debian-sys-maint),
          # que já tem usuário/senha configurados em /etc/mysql/debian.cnf
          sudo mysql --defaults-file=/etc/mysql/debian.cnf -e "CREATE DATABASE IF NOT EXISTS app_db;"
          sudo mysql --defaults-file=/etc/mysql/debian.cnf -e "CREATE USER IF NOT EXISTS 'app_user'@'%' IDENTIFIED BY 'app_pass';"
          sudo mysql --defaults-file=/etc/mysql/debian.cnf -e "GRANT ALL PRIVILEGES ON app_db.* TO 'app_user'@'%'; FLUSH PRIVILEGES;"

          # Testa a conexão usando o usuário da aplicação
          mysql -h 127.0.0.1 -uapp_user -papp_pass -e "SELECT 1" app_db

          # Aplica o init.sql (se existir) usando app_user
          if [ -f database/init.sql ]; then
            mysql -h 127.0.0.1 -uapp_user -papp_pass app_db < database/init.sql
          fi

        # instala as dependencias do python
      - name: Instalar dependências Python
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install -r frontend/requirements.txt
          pip install pytest pytest-cov httpx sqlalchemy pymysql
        # roda os unit tests contidos no arquivo test_unit_app_core
      - name: Unit tests
        run: |
          pytest -m "unit" --maxfail=1 --disable-warnings
        # roda os integration tests contidos no arquivo test_integration_app_api
      - name: Integration tests
        run: |
          pytest -m "integration" --maxfail=1 --disable-warnings

  # CD
  package:
    runs-on: ubuntu-latest
    needs: tests        # roda apenas se os testes passarem corretamente
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Empacotar API e Frontend
        run: |
          mkdir -p dist
          # copia arquivos necessários para deploy
          cp -r app dist/app
          cp -r frontend dist/frontend
          cp Vagrantfile dist/
          cp -r database dist/database || true
          cp README.md dist/ || true
          cd dist
          zip -r ../deploy-package.zip .
      # faz o empacotemento para o deploy
      - name: Publicar artifact de deploy
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy-package.zip